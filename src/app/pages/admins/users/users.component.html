<div class="container-fluid">
    <div class="card card-body mt-2 p-2">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" class="form-control" name="" id="">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Rut:</label>
                    <input type="text" class="form-control" name="" id="">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="text" class="form-control" name="" id="">
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label></label>
                    <button class="btn btn-block btn-info btn-fill">
                        Buscar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card card-body mt-2 p-2">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <button class="btn btn-block mt-2 btn-info btn-fill" (click)="openModal(template)">
                        Agregar
                    </button>
                    <select name="" class="form-control mt-2" id="">
                        <option *ngFor="let quant of SELECTS.QUANT" value="{{quant.value}}">{{quant.text}}</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <button class="btn btn-block mt-2 btn-success btn-fill" (click)="openModal(excelTemplate,'excel')">
                    Cargar excel
                </button>
            </div>
            <div class="col-md-3"></div>
            <div class="col-md-3">
                <div class="form-group">
                    <label>Buscar</label>
                    <input type="text" class="form-control" name="" id="">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <table style="text-align: center;" class="table table-hover">
                    <thead class="bg-dark" style="font-weight: bold;">
                        <tr>
                            <td style="font-weight: bold;">Rut</td>
                            <td style="font-weight: bold;">Nombre</td>
                            <td style="font-weight: bold;">Apellido</td>
                            <td style="font-weight: bold;">Email</td>
                            <td style="font-weight: bold;">Tipo de usuario</td>
                            <td style="font-weight: bold;">Accion</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let usr of users">
                            <td>{{usr.rut.substr(0, usr.rut.length - 1) | number}}-{{usr.rut.substr(usr.rut.length - 1)}}</td>
                            <td>{{usr.name}}</td>
                            <td>{{usr.lastname}}</td>
                            <td>{{usr.email}}</td>
                            <td>{{usr.type | translate}}</td>
                            <td>
                                <button class="btn btn-sm btn-info btn-fill m-1">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-fill m-1">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<ng-template #template>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Nuevo usuario</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12 pl-4 pr-4">
                <form [formGroup]="userForm" (ngSubmit)="onSubmit(userForm.value)">
                    <div class="form-group">
                        <label>Rut</label>
                        <input type="text" class="form-control" formControlName="rut" name="rut" (keyup)="formarRut()"
                            [ngClass]="{ 'is-invalid': (submitted && f.rut.errors) || (submitted && !validRut) }">
                        <div *ngIf="(submitted && f.rut.errors) || (submitted && !validRut)"
                            class="invalid-feedback text-danger">
                            <div *ngIf="f.rut.errors.required">Rut es requerido</div>
                            <div *ngIf="!validRut">Debe ingresar un rut valido</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contraseña</label>
                        <input type="password" class="form-control" formControlName="password"
                            [ngClass]="{ 'is-invalid': submitted && f.password.errors }">
                        <div *ngIf="submitted && f.password.errors" class="invalid-feedback text-danger">
                            <div *ngIf="f.password.errors.required">Contraseña es requerida</div>
                            <div *ngIf="f.password.errors.minlength">Minimo 6 caracteres</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" class="form-control" formControlName="name">
                    </div>
                    <div class="form-group">
                        <label>Apellido</label>
                        <input type="text" class="form-control" formControlName="lastname">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" class="form-control" formControlName="email"
                            [ngClass]="{ 'is-invalid': submitted && f.email.errors }">
                        <div *ngIf="submitted && f.email.errors" class="invalid-feedback text-danger">
                            <div *ngIf="f.email.errors.email">Debe ingresar un email válido</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de usuario</label>
                        <select class="form-control" formControlName="type"
                            [ngClass]="{ 'is-invalid': submitted && f.type.errors }">
                            <option *ngFor="let type of SELECTS.TYPEUSERS" value="{{type.value}}">{{type.text}}</option>
                        </select>
                        <div *ngIf="submitted && f.type.errors" class="invalid-feedback text-danger">
                            <div *ngIf="f.type.errors.required">Tipo de usuario es requerido</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button [disabled]="btnLoad" class="btn btn-block btn-info btn-fill">
                            {{btnLoad ? 'Cargando...' : 'Guardar'}}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #excelTemplate>
    <div class="modal-header">
        <h4 class="modal-title pull-left">Cargar Excel</h4>
        <button type="button" class="close pull-right" aria-label="Close" (click)="modalRef.hide()">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <input type="file" accept=".xlsx, .xls, .csv" multiple="false" (change)="onFileChange($event)" class="form-control" name=""
                        id="">
                </div>
                <div *ngIf="validateExcel.load" class="text-center">
                    <img src="assets/img/spinner.gif" alt="">
                </div>
                <div *ngIf="validateExcel.isValid && validateExcel.finish && !validateExcel.load" style="overflow: auto;">
                    <table style="text-align: center;" class="table table-hover">
                        <thead class="bg-dark">
                            <tr>
                                <th style="font-weight: bold; color: white;">
                                    Nº
                                </th>
                                <th style="font-weight: bold; color: white;" class="text-center" *ngFor="let row of headerTable[0]">{{row}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of bodyTable; let i = index" [ngClass]="{'bg-danger': row[6] == 'ERROR!'}">
                                <td>
                                    {{i+1}}
                                </td>
                                <td *ngFor="let val of row">
                                    {{val}}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div *ngIf="!validateExcel.isValid && validateExcel.finish && !validateExcel.load">
                    <div class="alert alert-danger text-center">
                        <strong>Formato de excel inválido!</strong>
                    </div>
                    <div class="alert alert-warning text-center">
                        Excel debe contar con (Rut, Nombre, Email, Contraseña, Carrera, Categoria, Asignatura, Seccion, Año, Periodo)
                    </div>
                </div>
                <div *ngIf="!validateExcel.segmentsIsValid">
                    <div class="alert alert-danger text-center">
                        <strong>Segmentaciones incorrectas!</strong>
                    </div>
                </div>
            </div>
            <div class="col-md-12 mt-4 text-center">
                <button *ngIf="validateExcel.isValid" [disabled]="!validateExcel.segmentsIsValid" class="btn btn-success btn-fill" (click)="saveUsers()">Cargar datos</button>
            </div>
        </div>
    </div>
</ng-template>